<!DOCTYPE html>
<html>

<head>
  {% load staticfiles %}
  {% load humanize %}
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="{% static "icons/stethoscope.ico" %}" />
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.css" />
  <script src="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static "style/style.css" %}"rel="stylesheet" type="text/css" />
</head>

<body>
  <div data-role="page" data-title="{{data.practitioner.name}} | doctorsinfo.pk">
    <div data-role="header">
      <h1><a href="/" class="anchor-link" ><i class="fa fa-stethoscope fa-1x marg-r"></i>doctorsinfo.pk</a></h1>
      <div id="head">
      {% if data.user.is_authenticated %}
      <a href="{% url 'patient' %}" class="anchor-link"><i class="fa fa-user fa-1x marg-r"></i>{{data.user.username}}</a>
      {% else %}
        <a href="/login/" class="anchor-link" >Login</a><span>&nbsp;/</span>
        <a href="/register/" style: class="anchor-link" >Register</a>
      {% endif %}
      </div>
    </div>
    <div role="main" class="ui-content">
    <div id="border-left"></div>
    <div id="border-right"></div>

      <!-- Practitioner Details -->
      <div id="practitionerDetails">
        {% if not data.favourite %}
        <span id="bookmark" class="silver-img"><i class="fa fa-star-o fa-2x favourite" title="add to favourite list"></i></span>
        {% else %}
        <span class="silver-img"><i class="fa fa-star fa-2x" title="Already on Favourite List"></i></span>
        {% endif %}
        <h1><i class="fa fa-user-md fa-1x marg-r"></i>{{data.practitioner.name}}</h1>
        <span>{{data.practitioner.credentials}}</span>
        <span>Specialized in: {% for speciality in data.practitioner.specialities.all.iterator %}{{speciality.name}}</span>
        {% endfor %}
        <span>Experience: <strong>{{data.practitioner.experience}} years.</strong></span>
        <span><strong>Achievements: </strong>{{data.practitioner.achievements}}</span>
      </div>

      <!-- Practice-Location Details -->
      {% for pract in data.practice.iterator %}
      <div class="grid-name">
        {% ifequal pract.practice_type "P" %}
        <h2 style="background-color: #4b555d;">{{pract.practitioner.name}}</h2>
        {% else %}
        <h2 style="background-color: #4b555d;">{{pract.practice_location.name}}</h2>
        {% endifequal %}
        <div class="clinic">
          <!-- Load Clinic Timings -->
          <ul>
          <div class="clock" id="/practice/{{pract.practice_location.slug}}/{{pract.practitioner.slug}}/">
          {% include "practitioner/clinictimings.html" %}
          <li><img src="{% static "icons/clock.png" %} "height="22" width="24" title="Clinic Timings." />
          <strong class="timings">Practice Timing.</strong></li>
          </div>
          <!-- Load Clinic Timings -->
            <br>
            <li><i class="fa fa-money" title="Checkup Fee."></i><span><strong>{{pract.checkup_fee}} rs.</strong></span></li>
            <li><i class="fa fa-phone"></i><span><u>{{pract.contact_number}}</u></span></li>
            <li><i class="fa fa-calendar" title="Appointment Only or Waiting"></i>{% if pract.appointments_only %}<span>Appointment Required: <b>Yes.</b></span>{% else %}<span>Checkup on Waiting: <b>Yes.</b></span>{% endif %}</li>
            <li><i class="fa fa-location-arrow"></i><span>{{pract.practice_location.clinic_address}}, {{pract.practice_location.city.name}}.</span></li>
            <li><i class="fa fa-medkit fa-1x" title="Services Offered."></i><span>Services: {{pract.services}}</span></li>
          </ul>
          <div class="modified"><img src="{% static "icons/mod.png" %}"height="18" width="18" title="Last Updated"/>
          <span>{{pract.modified|naturaltime}}</span></div>
          <!-- Lat Long -->
          {% if pract.practice_location.lat and pract.practice_location.lon %}
            <a href="http://maps.google.com/maps?z=12&t=m&q={{pract.practice_location.lon}},{{pract.practice_location.lat}}" target="_blank" class="anchor-link-right map-marker" ><i style="padding: 0px 0px 10px 0px;" class="fa fa-map-marker fa-3x"></i></a>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <!-- Practitioner Reviews Details -->
      <div class="grid-name">
        <h2 style="background-color: #4b555d;">Practice Reviews</h2>
        <div class="reviews">
          {% if data.reviews.exists %} 
            <!-- Post new Reviews, user loged in & Reviews exists -->
            {% if data.user.is_authenticated %}
          <form class="reviewBox" action="{% url 'addreview' %}" method="POST" class="inline_">{% csrf_token %}
              {% if data.practice.count > 1 %}
              <select name="practice_slug" required>
              <option value="">- Select Practice Location -</option>
              {% for pract in data.practice.iterator %}
              <option value="{{pract.practice_location.slug}}">{{pract.practice_location.name}}</option>
              {% endfor %}
              </select>
              <textarea cols="8" rows="8" name="review_text" required></textarea>
              <input type="hidden" name="slug" value="{{data.practitioner.slug}}">             
              {% else %}
              <textarea cols="8" rows="8" name="review_text" required></textarea>
              <input type="hidden" id="slug" name="slug" value="{{data.practitioner.slug}}">
              {% for pract in data.practice.iterator %}
              <input type="hidden" id="practice_slug" name="practice_slug" value="{{pract.practice_location.slug}}">
              {% endfor %}
              {% endif %}
              <button type="submit" id="post-review-btn" class="ui-btn ui-corner-all ui-btn-a">Post</button>
          </form>
            {% endif %}
          {% for pr in data.reviews.iterator %}
          <!-- Load Reviews, user loged in, Reviews exists-->
           {% if data.user.is_authenticated %}
           <!--Load Reviews with up-down votes -->
          <div class="oneComment">
            <span class="patientName inlineB">{% if pr.patient.user.get_full_name %}
            {{pr.patient.user.get_full_name}}{% else %}{{pr.patient}}{% endif %}</span>
            <span class="commentDate float-right inlineB"><i class="fa fa-clock-o marg-r"></i>{{pr.review_date|naturaltime}}</span>
            <span class="comment break marg-l">{{pr.review_text}}</span>
            <!-- review upVote-->
            <i class="fa fa-thumbs-o-up up" id="/review/{{pr.pk}}/"></i>
            <span class="up_votes marg-r">{{pr.up_votes}}</span>-
            <span class="down_votes marg-l">{{pr.down_votes}}</span>
            <!-- review downVote-->
            <i class="fa fa-thumbs-o-down marg-l down" id="/review/{{pr.pk}}/"></i>
          </div>
          <!-- No user login and reviews exists-->
          {% else %}
          <div class="oneComment">
            <span class="patientName inlineB">{% if pr.patient.user.get_full_name %}
            {{pr.patient.user.get_full_name}}{% else %}{{pr.patient}}{% endif %}</span>
            <span class="float-right inlineB commentDate"><i class="fa fa-clock-o marg-r"></i>{{pr.review_date|naturaltime}}</span>
            <span class="comment break marg-l">{{pr.review_text}}</span>
            <span class="up_votes inlineB">agree. {{pr.up_votes}} - </span>
            <span class="down_votes inlineB">{{pr.down_votes}}  diagree.</span>
          </div>
          {% endif %}
          {% endfor %}
          {% if not data.user.is_authenticated %}
          <!-- No user login and reviews exists-->
          <a href="#popupMenu" data-rel="popup" data-transition="slideup" class="anchor-link-right marg-t" >add review..</a>
          <div data-role="popup" id="popupMenu" data-theme="b">
          <ul data-role="listview" data-inset="true" style="min-width:210px;">
          <li><a href="/login/" >Login</a></li>
          <li><a href="/register/" >Sign Up</a></li>
          </ul>
          </div>
          {% endif %}
          <!-- No user login and reviews exists-->
          {% else %}
            {% if data.user.is_authenticated %}
            <!-- user login and no review exists-->
          <span class="textCentre marg-l break"><strong>No reviews yet, Make One.</strong></span>
          <div>
          <form class="reviewBox" action="{% url 'addreview' %}" method="POST" class="inline_">{% csrf_token %}
              {% if data.practice.count > 1 %}
              <select name="practice_slug" required>
              <option value="">- Select Practice Location -</option>
              {% for pract in data.practice.iterator %}
              <option value="{{pract.practice_location.slug}}">{{pract.practice_location.name}}</option>
              {% endfor %}
              </select>
              <textarea cols="8" rows="8" id="review_text" name="review_text" required></textarea>
              <input type="hidden" name="slug" value="{{data.practitioner.slug}}">             
              {% else %}
              <textarea cols="8" rows="8" id="review_text" name="review_text" required></textarea>
              <input type="hidden" name="slug" value="{{data.practitioner.slug}}">
              {% for pract in data.practice.iterator %}
              <input type="hidden" name="practice_slug" value="{{pract.practice_location.slug}}">
              {% endfor %}
              {% endif %}
              <button type="submit" id="post-review-btn" class="ui-btn ui-corner-all ui-btn-a">Post</button>
          </form></div>
            {% else %}
         <!-- Post new Review / no user login-->
         <span class="marg-l break"><strong>No reviews yet.</strong></span>
          <a href="#popupMenu" data-rel="popup" data-transition="slideup" class="anchor-link-right marg-t" >add review..</a>
          <div data-role="popup" id="popupMenu" data-theme="b">
          <ul data-role="listview" data-inset="true" style="min-width:210px;">
          <li><a href="/login/" >Login</a></li>
          <li><a href="/register/" >Sign Up</a></li>
          </ul>
          </div>
            {% endif %}
         {% endif %}
        </div>
      </div>
    </div>
    <!-- Footer Details -->
    <div class="foot" data-role="footer">
      <h4>
      <a href="https://www.facebook.com/doctorsinfo.pk" target="_blank"><i class="fa fa-facebook fa-1x"></i></a>
      <a href="mailto:doctorsinfo.pk@gmail.com"><i class="fa fa-envelope fa-1x"></i></a>
      <a href="http://twitter.com/doctorsinfo_pk" target="_blank"><i class="fa fa-twitter fa-1x"></i></a></h4>
    </div>
  </div>
  <script type="text/javascript">
    /* new Review */
    $(document).ready(function() {
      var comment = $('.reviewBox');
      comment.submit(function(ev) {
        var doc = "{{data.favourite}}";
        if (doc == "False")
          $.ajax({
            type: "POST",
            url: $(this).attr('action'),
            context: this,
            data: { slug: $(this).attr('slug'), practice_slug: $(this).attr('action'), review_text: $(this).attr('review_text') },
            success: function(data){
              if (data.msg != null) {
                alert(data.msg);
                $(this).hide();
              } else {
                //$(this).hide();
                $(this).append('<div class="oneComment">
                  <span class="patientName inlineB">'data.patient'</span>
                  <span class="float-right inlineB commentDate"><i class="fa fa-clock-o marg-r"></i>{% now "jS F Y H:i" %}</span>
                  <span class="comment break marg-l">'data.review_text'</span>
                  </div>');
                }
              },
            dataType: 'json',
          });
      });
    });
    // csrfmiddlewaretoken: '{{ csrf_token }}'}
    /*  Load timings */
    $(document).ready(function() {
      $('.clock').click(function(ev) {
        console.log('clock click');
        $.ajax({
          type: "GET",
          url: $(this).attr('id'),
          context: this,
          success: function(data) {
            $(this).prepend(data);
            $(this).unbind('click');
          },
          dataType: 'html'
        });
      });
    });
    /* favt	*/
    $(document).ready(function() {
      var favtImg = $('.favourite');
      favtImg.click(function(ev) {
        var doc = "{{data.favourite}}";
        if (doc == "False")
          $.ajax({
            type: "POST",
            url: '/patient/',
            context: this,
            data: { type_: "favourite", favt_slug: '{{data.practitioner.slug}}',csrfmiddlewaretoken: '{{ csrf_token }}'},
            success: function(data) {
              if (data.status_) {
                $(this).hide();
                $('#bookmark').append('<i class="fa fa-star fa-2x" title="added to Favourite List"></i>');
              }
            },
            dataType: 'json',
          });
      });
    });
    /* up vote */
    $(document).ready(function() {
      var up = $('.up');
      up.click(function(ev) {
        $.ajax({
          type: "POST",
          url: $(this).attr('id'),
          context: this,
          data: {
            up: "up",
            prac_slug: "{{data.practitioner.slug}}",
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(data) {
            var up = $(this).next('.up_votes').text(data.up);
            down = up.next('.down_votes');
            up.text(data.up);
            down.text(data.down);
            $(this).unbind('click');
          },
          dataType: 'json',
        });
      });
    });
    /* down vote */
    $(document).ready(function() {
      var down = $('.down');
      down.click(function(ev) {
        $.ajax({
          type: "POST",
          url: $(this).attr('id'),
          context: this,
          data: {
            down: "down",
            prac_slug: "{{data.practitioner.slug}}",
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(data) {
            var down = $(this).prev('.down_votes');
            var up = down.prev('.up_votes');
            down.text(data.down);
            up.text(data.up);
            $(this).unbind('click');
          },
          dataType: 'json'
        });
      });
    });
  </script>
</body>
</html>